FROM node:18

ARG HOST
ARG PORT=1337
ARG APP_KEYS
ARG API_TOKEN_SALT
ARG ADMIN_JWT_SECRET
ARG JWT_SECRET
ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_NAME
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG DATABASE_SSL
ARG INSTANCE_CONNECTION_NAME
ARG APP_KEYS

WORKDIR /content

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

COPY . .
RUN HOST=$HOST PORT=$PORT APP_KEYS=$APP_KEYS API_TOKEN_SALT=$API_TOKEN_SALT ADMIN_JWT_SECRET=$ADMIN_JWT_SECRET JWT_SECRET=$JWT_SECRET DATABASE_HOST=$DATABASE_HOST DATABASE_PORT=$DATABASE_PORT DATABASE_NAME=$DATABASE_NAME DATABASE_USERNAME=$DATABASE_USERNAME DATABASE_PASSWORD=$DATABASE_PASSWORD DATABASE_SSL=$DATABASE_SSL INSTANCE_CONNECTION_NAME=$INSTANCE_CONNECTION_NAME APP_KEYS=$APP_KEYS yarn build
RUN npm prune --production

EXPOSE $PORT
CMD ["yarn", "start"]
